version: 0.2

env:
  variables:
    LAMBDA_NAME: "Testing_CICD"  # Set in CodeBuild environment

phases:
  install:
    runtime-versions:
      python: 3.9
    commands:
      - echo "Installing AWS CLI..."
      - pip install --upgrade awscli

  pre_build:
    commands:
      - echo "Cloning repository..."
      - git clone https://github.com/khajum7/web.git
      - cd /khajum7/web
      - echo "Fetching changed files..."
      - git fetch origin main  # Ensure latest commit history, replace 'main' with 'master' if needed
      - CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | tr '\n' ' ')  # Get modified files in one line
      - |
        if [ -z "$CHANGED_FILES" ]; then
          echo "No files changed. Skipping build.";
          exit 0;  # Exit early if no files changed
        else
          echo "Modified files: $CHANGED_FILES";
        fi


  build:
    commands:
      - echo "Checking if there are files to update..."
      - |
        if [ -z "$CHANGED_FILES" ]; then
          echo "No files changed. Skipping deployment.";
          exit 0;  # Exit early if no files changed
        else
          echo "Zipping only changed files...";
          zip lambda_function.zip $CHANGED_FILES;
          echo "Updating Lambda function: $LAMBDA_NAME";
          aws lambda update-function-code --function-name "$LAMBDA_NAME" --zip-file fileb://lambda_function.zip;
        fi

  post_build:
    commands:
      - echo "Lambda function $LAMBDA_NAME updated successfully!"
